<!DOCTYPE html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creditera Bar</title>
    <!-- development -->
    <link rel="stylesheet" href="./styles.css">
    
    <!-- production -->
    <!-- <link rel="stylesheet" href="./styles.css"> -->

    <link rel="shortcut icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  
  <body>
    <div class="layout container">
      <h1><img src="/creditera.svg" alt="Creditera.bg" /> • Bar</h1>
    
      <div class="panel">
        <creditera-bar id="calculator" price="200000" redirect-url="https://creditera.app.finbryte.com/form/3d182075-e6be-4d48-9ac6-3af5ab3f8a2c" />
      </div>
      
      <div class="panel">
        <div class="inner">
          <h2>1. Инсталиране</h2>
          <p>Свалете скрипт файла за локално използване и го имплементирайте в страницата, където ще използвате бара:</p>
          <button id="download-script-btn" class="download-btn">creditera-bar.js</button>
        </div>
        
        <div>
          <h2 style="margin-top: 2em">2. Конфигуриране</h2>
          <p>Настройте аргументите на бара от тук, в случай че искате да го използвате статично:</p>
          <div class="form">
            <div class="control-group">
              <label for="price-input">Цена на имот (€)</label>
              <input type="number" id="price-input" value="200000" min="1000" step="1000">
            </div>
            
            <div class="control-group">
              <label for="max-period-input">Макс. период (год.)</label>
              <input type="number" id="max-period-input" value="30" min="4" max="30">
            </div>
            
            <div class="control-group">
              <label for="interest-input">Лихва (%)</label>
              <input type="number" id="interest-input" value="2.19" min="1" max="10" step="0.01">
            </div>
            
            <div class="control-group">
              <label for="loan-cap-input">Макс. кредит (%)</label>
              <input type="number" id="loan-cap-input" value="85" max="85" step="1">
            </div>
            
            <div class="control-group">
              <label for="redirect-url-input">Адрес на формуляр</label>
              <input type="url" id="redirect-url-input" value="https://creditera.app.finbryte.com/form/3d182075-e6be-4d48-9ac6-3af5ab3f8a2c" required>
            </div>
            
            <div class="control-group">
              <label for="alignment-input">Подравняване</label>
              <select id="alignment-input">
                <option value="left" selected>Ляво</option>
                <option value="center">Център</option>
              </select>
            </div>
            
            <div class="control-group">
              <label for="primary-color-input">Акцент</label>
              <input type="color" id="primary-color-input" value="#00AA33">
            </div>
            
            <div class="control-group">
              <label for="bg-color-input">Фон</label>
              <input type="color" id="bg-color-input" value="#E6E6E6">
            </div>
          </div>
        </div>

        <div class="inner">
          <h2 style="margin-top: 2em">3. Резултат</h2>
          <p>Копирайте този код и го поставете в страницата, където искате да се появи бара:</p>
          <pre id="code-preview"><code id="code-content">&lt;creditera-bar price="200000" redirect-url="https://creditera.app.finbryte.com/form/3d182075-e6be-4d48-9ac6-3af5ab3f8a2c"&gt;&lt;/creditera-bar&gt;</code></pre>
        </div>
      </div>

      <div class="panel">
        <div class="inner" id="readme-content">
          <p>Зареждане на документацията...</p>
        </div>
      </div>
    </div>

    <!-- development -->
    <script type="module" src="./src/creditera-bar.js"></script>

    <!-- production -->
    <!-- <script src="./dist/creditera-bar.js"></script> -->
    
    <script>
          // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      const calculator = document.getElementById('calculator');
      const priceInput = document.getElementById('price-input');
      const maxPeriodInput = document.getElementById('max-period-input');
      const interestInput = document.getElementById('interest-input');
      const loanCapInput = document.getElementById('loan-cap-input');
      const redirectUrlInput = document.getElementById('redirect-url-input');
      const bgColorInput = document.getElementById('bg-color-input');
      const primaryColorInput = document.getElementById('primary-color-input');
      const alignmentInput = document.getElementById('alignment-input');
      const codeContent = document.getElementById('code-content');
      const codePreview = document.getElementById('code-preview');
      const readmeContent = document.getElementById('readme-content');
      const downloadScriptBtn = document.getElementById('download-script-btn');
        
        // Function to get query parameters from URL
        function getQueryParams() {
          const params = new URLSearchParams(window.location.search);
          return {
            price: params.get('price'),
            maxPeriod: params.get('maxPeriod'),
            interest: params.get('interest'),
            loanCap: params.get('loanCap'),
            redirectUrl: params.get('redirectUrl'),
            primaryColor: params.get('primaryColor'),
            bgColor: params.get('bgColor'),
            alignment: params.get('alignment')
          };
        }
        
        // Function to update URL with current form values
        function updateURL() {
          const params = new URLSearchParams();
          
          // Only add parameters if they differ from defaults
          if (priceInput.value !== '200000') {
            params.set('price', priceInput.value);
          }
          
          if (maxPeriodInput.value !== '30') {
            params.set('maxPeriod', maxPeriodInput.value);
          }
          
          if (interestInput.value !== '2.19') {
            params.set('interest', interestInput.value);
          }
          
          if (loanCapInput.value !== '85') {
            params.set('loanCap', loanCapInput.value);
          }
          
          if (redirectUrlInput.value !== 'https://creditera.app.finbryte.com/form/3d182075-e6be-4d48-9ac6-3af5ab3f8a2c') {
            params.set('redirectUrl', redirectUrlInput.value);
          }
          
          if (primaryColorInput.value.toLowerCase() !== '#00aa33') {
            params.set('primaryColor', primaryColorInput.value);
          }
          
          if (bgColorInput.value.toLowerCase() !== '#e6e6e6') {
            params.set('bgColor', bgColorInput.value);
          }
          
          if (alignmentInput.value !== 'left') {
            params.set('alignment', alignmentInput.value);
          }
          
          // Update the URL without reloading the page
          const newURL = params.toString() ? 
            `${window.location.pathname}?${params.toString()}` : 
            window.location.pathname;
          
          window.history.replaceState({}, '', newURL);
        }
        
        // Function to prefill inputs from query parameters
        function prefillFromQuery() {
          const queryParams = getQueryParams();
          
          if (queryParams.price && !isNaN(queryParams.price)) {
            priceInput.value = queryParams.price;
          }
          
          if (queryParams.maxPeriod && !isNaN(queryParams.maxPeriod)) {
            const maxPeriod = Math.min(30, Math.max(1, parseInt(queryParams.maxPeriod)));
            maxPeriodInput.value = maxPeriod;
          }
          
          if (queryParams.interest && !isNaN(queryParams.interest)) {
            const interest = Math.min(10, Math.max(1, parseFloat(queryParams.interest)));
            interestInput.value = interest;
          }
          
          if (queryParams.loanCap && !isNaN(queryParams.loanCap)) {
            const loanCap = Math.min(85, Math.max(1, parseInt(queryParams.loanCap)));
            loanCapInput.value = loanCap;
          }
          
          if (queryParams.redirectUrl) {
            redirectUrlInput.value = queryParams.redirectUrl;
          }
          
          if (queryParams.primaryColor && /^#[0-9A-F]{6}$/i.test(queryParams.primaryColor)) {
            primaryColorInput.value = queryParams.primaryColor;
          }
          
          if (queryParams.bgColor && /^#[0-9A-F]{6}$/i.test(queryParams.bgColor)) {
            bgColorInput.value = queryParams.bgColor;
          }
          
          if (queryParams.alignment && (queryParams.alignment === 'left' || queryParams.alignment === 'center')) {
            alignmentInput.value = queryParams.alignment;
          }
        }
        
        // Function to generate the code preview
        function generateCodePreview() {
          const attributes = [];
          
          // Always include price and url (both required)
          attributes.push(`price="${priceInput.value}"`);
          attributes.push(`redirect-url="${redirectUrlInput.value}"`);
          
          // Add maxPeriod if different from default (30)
          if (maxPeriodInput.value !== '30') {
            attributes.push(`max-period="${maxPeriodInput.value}"`);
          }
          
          // Add interest if different from default (2.19)
          if (interestInput.value !== '2.19') {
            attributes.push(`interest="${interestInput.value}"`);
          }
          
          // Add loan cap if different from default (85)
          if (loanCapInput.value !== '85') {
            attributes.push(`loan-cap-percent="${loanCapInput.value}"`);
          }
          
          // Add background color if different from default
          if (bgColorInput.value !== '#e6e6e6') {
            attributes.push(`background-color="${bgColorInput.value}"`);
          }
          
          // Add primary color if different from default
          if (primaryColorInput.value !== '#00aa33') {
            attributes.push(`primary-color="${primaryColorInput.value}"`);
          }
          
          // Add alignment if different from default
          if (alignmentInput.value !== 'left') {
            attributes.push(`alignment="${alignmentInput.value}"`);
          }
          
          // Format as multi-line with proper indentation
          if (attributes.length === 0) {
            return `&lt;creditera-bar&gt;&lt;/creditera-bar&gt;`;
          }
          
          return `&lt;creditera-bar\n  ${attributes.join('\n  ')}\n&gt;&lt;/creditera-bar&gt;`;
        }
        
        // Function to update the calculator and code preview
        function updateCalculator() {
          calculator.setAttribute('price', priceInput.value);
          calculator.setAttribute('max-period', maxPeriodInput.value);
          calculator.setAttribute('interest', interestInput.value);
          calculator.setAttribute('loan-cap-percent', loanCapInput.value);
          calculator.setAttribute('redirect-url', redirectUrlInput.value);
          calculator.setAttribute('background-color', bgColorInput.value);
          calculator.setAttribute('primary-color', primaryColorInput.value);
          calculator.setAttribute('alignment', alignmentInput.value);
          
          // Update code preview
          codeContent.innerHTML = generateCodePreview();
          
          // Update URL with current values
          updateURL();
        }
        
        // Function to generate the script tag
        function generateScriptTag() {
          const hostname = window.location.hostname;
          const protocol = window.location.protocol;
          const port = window.location.port ? ':' + window.location.port : '';
          const scriptPath = `${protocol}//${hostname}${port}/creditera-bar.js`;
          return `&lt;script src="${scriptPath}"&gt;&lt;/script&gt;`;
        }
        
        // Function to generate the local script path
        function generateLocalScriptPath() {
          const hostname = window.location.hostname;
          const protocol = window.location.protocol;
          const port = window.location.port ? ':' + window.location.port : '';
          return `${protocol}//${hostname}${port}/creditera-bar.js`;
        }
        
        // Function to select all code when pre element is clicked
        function selectAllCode() {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(codeContent);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        // Function to select all script code when script pre element is clicked
        function selectAllScript() {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(scriptContent);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        // Function to select all path code when path pre element is clicked
        function selectAllPath() {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(pathContent);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        // Function to download the script file
        async function downloadScript() {
          const possiblePaths = [
            './creditera-bar.js',        // Root level (when serving from dist)
            './dist/creditera-bar.js',   // Dist subdirectory
            './src/creditera-bar.js'     // Development path
          ];
          
          for (let i = 0; i < possiblePaths.length; i++) {
            const path = possiblePaths[i];
            console.log(`Trying to fetch script from: ${path}`);
            
            try {
              const response = await fetch(path);
              if (!response.ok) {
                console.log(`Path ${path} returned status: ${response.status}`);
                continue; // Try next path
              }
              
              const contentType = response.headers.get('content-type');
              console.log(`Found script at ${path}, content-type:`, contentType);
              
              const scriptContent = await response.text();
              
              // Check if we got HTML instead of JS
              if (scriptContent.trim().startsWith('<!DOCTYPE') || scriptContent.trim().startsWith('<html')) {
                console.log(`Path ${path} returned HTML instead of JavaScript`);
                continue; // Try next path
              }
              
              // Validate that we got JavaScript content
              if (!scriptContent || scriptContent.length < 10) {
                console.log(`Path ${path} returned content that's too short`);
                continue; // Try next path
              }
              
              console.log('Script content preview:', scriptContent.substring(0, 100) + '...');
              
              // Create a blob with the script content
              const blob = new Blob([scriptContent], { type: 'application/javascript' });
              const url = URL.createObjectURL(blob);
              
              // Create a temporary download link
              const a = document.createElement('a');
              a.href = url;
              a.download = 'creditera-bar.js';
              document.body.appendChild(a);
              a.click();
              
              // Clean up
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              
              console.log('Download initiated successfully!');
              return; // Success - exit function
              
            } catch (error) {
              console.log(`Error fetching from ${path}:`, error.message);
              continue; // Try next path
            }
          }
          
          // If we get here, all paths failed
          alert('Грешка при сваляне на скрипта: Файлът не може да бъде намерен на нито една от очакваните локации.\n\nОпитайте директно да отворите един от следните URL адреси в браузъра:\n• ./creditera-bar.js\n• ./dist/creditera-bar.js\n• ./src/creditera-bar.js');
        }
        
        // Function to load and parse README.md content
        async function loadReadmeContent() {
          try {
            const response = await fetch('./README.md');
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const markdownText = await response.text();
            
            // Parse markdown to HTML using marked.js
            const htmlContent = marked.parse(markdownText);
            
            // Insert the parsed HTML into the readme-content div
            readmeContent.innerHTML = `<div class="inner">${htmlContent}</div>`;
          } catch (error) {
            console.error('Error loading README.md:', error);
            readmeContent.innerHTML = '<div class="inner"><p>Грешка при зареждане на документацията.</p></div>';
          }
        }
        
        // Prefill inputs from query parameters on page load
        prefillFromQuery();
        
        // Add event listeners to all inputs
        priceInput.addEventListener('input', updateCalculator);
        maxPeriodInput.addEventListener('input', updateCalculator);
        interestInput.addEventListener('input', updateCalculator);
        loanCapInput.addEventListener('input', updateCalculator);
        redirectUrlInput.addEventListener('input', updateCalculator);
        bgColorInput.addEventListener('input', updateCalculator);
        primaryColorInput.addEventListener('input', updateCalculator);
        alignmentInput.addEventListener('change', updateCalculator);
        
        // Add click event listeners to code previews
        codePreview.addEventListener('click', selectAllCode);
        
        // Add download button event listener
        downloadScriptBtn.addEventListener('click', downloadScript);
        
        // Initialize the code preview
        updateCalculator();
        
        // Load and parse README.md content
        loadReadmeContent();
      });
    </script>
  </body>
</html>